name: ðŸ§¹Clean up PR
on:
  pull_request:
    types:
      - closed

jobs:
  clean-up:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    concurrency:
      group: pr-clean-up-${{ github.event.pull_request.number }}
    env:
      PR_NAME: pr-${{ github.event.pull_request.number }}
    environment:
      name: dev
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - uses: opentofu/setup-opentofu@v1
      - name: Destroy PR preview
        run: cd infra && tofu init -backend-config=backends/dev.tfbackend -backend-config="key=website-${{ env.PR_NAME }}.tfstate" && tofu destroy -auto-approve
        env:
          SCW_ACCESS_KEY: ${{ secrets.SCW_ACCESS_KEY }}
          SCW_SECRET_KEY: ${{ secrets.SCW_SECRET_KEY }}
          AWS_ACCESS_KEY_ID: ${{ secrets.SCW_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.SCW_SECRET_KEY }}
          TF_VAR_organization_id: ${{ secrets.SCW_ORGANIZATION_ID }}
          TF_VAR_project_id: ${{ secrets.SCW_PROJECT_ID }}
          TF_VAR_stage: dev
          TF_VAR_bucket_name_suffix: ${{ env.PR_NAME }}